{"version":3,"sources":["api/dashboard/dashboard.controller.js"],"names":["profile","Users","require","ref","DB","rad","x","Math","PI","getDistance","p1","p2","R","dLat","lat","dLong","long","a","sin","cos","c","atan2","sqrt","d","req","res","find","IsActive","then","snapshot","allUser","authData","Lat","Long","console","log","forEach","item","MobileNumber","push","userArr","dist","Password","Distance","index","Images","length","fileName","Name","url","Profile","send","catch","err"],"mappings":"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","file":"dashboard.controller.js","sourcesContent":["/* eslint-disable import/prefer-default-export,no-mixed-operators,no-param-reassign,no-unused-vars */\nimport DB from '../../config/firebase';\nimport async from 'async';\nimport { getUrl } from '../minio/minio.controller';\n\nconst Users = require('../user/user.model');\n\nconst ref = DB.ref('server');\nfunction rad(x) {\n  return x * Math.PI / 180;\n}\n\nfunction getDistance(p1, p2) {\n  const R = 6378137; // Earthâ€™s mean radius in meter\n  const dLat = rad(p2.lat - p1.lat);\n  const dLong = rad(p2.long - p1.long);\n  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n        Math.cos(rad(p1.lat)) * Math.cos(rad(p2.lat)) *\n        Math.sin(dLong / 2) * Math.sin(dLong / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  const d = R * c;\n  return d; // returns the distance in meter\n}\n\nexport function profile(req, res) {\n  // const usersRef = ref.child('users');\n  Users.find({ IsActive: 1 }).then((snapshot) => {\n    const allUser = [];\n    const lat = req.authData.Lat;\n    const long = req.authData.Long;\n    const p1 = {\n      lat,\n      long,\n    };\n    console.log(p1);\n    snapshot.forEach((item) => {\n      if (req.authData.MobileNumber !== item.MobileNumber) { allUser.push(item); }\n    });\n    const userArr = [];\n    allUser.forEach((item) => {\n      const p2 = {\n        lat: item.Lat,\n        long: item.Long,\n\n      };\n      if (p1.lat && p1.long && p2.lat && p2.long) {\n        const dist = getDistance(p1, p2);\n        console.log('dd', dist);\n        if (dist < 5000) {\n          delete item.Password;\n          item.Distance = dist;\n          userArr.push(item);\n        }\n      }\n    });\n    userArr.forEach((item, index) => {\n      if (item.Images.length > 0) {\n        const fileName = item.Images[item.Images.length - 1].Name;\n        getUrl(fileName).then((url) => {\n          item.Profile = url;\n          if (userArr.length === index + 1) {\n            res.send(userArr);\n          }\n        }).catch((err) => {\n          item.Profile = null;\n          if (userArr.length === index + 1) {\n            res.send(userArr);\n          }\n        });\n      } else {\n        item.Profile = null;\n        if (userArr.length === index + 1) {\n          console.log('aa');\n          res.send(userArr);\n        }\n      }\n    });\n  });\n}\n"]}