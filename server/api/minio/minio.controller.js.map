{"version":3,"sources":["api/minio/minio.controller.js"],"names":["setData","getUrl","Minio","require","Users","minioClient","Client","endPoint","useSSL","accessKey","secretKey","putObject","newPath","fileStream","res","data","req","console","log","bodyImage","process","env","MINIO_BUCKET_NAME","err3","etag","json","status","msg","fromWhere","Name","IsActive","URL","WhichImage","imageData","isActive","condition","_id","authData","findOneAndUpdate","$push","Images","new","then","result","userResult","Password","send","catch","err","body","matches","index","indexOf","s1","substring","i","type","base64Data","split","Date","now","Math","ceil","random","Buffer","from","bucketExists","err2","exists","makeBucket","err1","getUrlNew","fileName","resolve","reject","presignedUrl","url"],"mappings":"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","file":"minio.controller.js","sourcesContent":["/* eslint-disable import/prefer-default-export,\nno-unused-vars,no-useless-escape,no-underscore-dangle */\nconst Minio = require('minio');\nconst Users = require('../user/user.model');\n\nconst minioClient = new Minio.Client({\n  endPoint: 'object.mobinext.tech',\n  useSSL: true,\n  accessKey: 'NXYWVCS8LF35W684YEUT', // process.env.MINIO_ACCESSKEY,\n  secretKey: 'e4ms5zotElnAAvnki9JG79HMRATAjvrlgGnIuoyU', // process.env.MINIO_SECRETKEY,\n});\n\n// const getMinioClient = new Minio.Client({\n//   endPoint: 'env-8478623.mj.milesweb.cloud',\n//   port: 9000,\n//   useSSL: true,\n//   accessKey: process.env.MINIO_ACCESSKEY,\n//   secretKey: process.env.MINIO_SECRETKEY,\n// });\nfunction putObject(newPath, fileStream, res, data, req) {\n  console.log('hehe');\n  const bodyImage = data;\n  return minioClient.putObject(process.env.MINIO_BUCKET_NAME,\n    newPath, fileStream, (err3, etag) => {\n      if (err3) {\n        return res.json({ status: 500, msg: 'Image failed to push in Minio' });\n      } else if (bodyImage.fromWhere === 'user') {\n        bodyImage.Name = newPath;\n        bodyImage.IsActive = true;\n        bodyImage.URL = null;\n        delete bodyImage.WhichImage;\n        delete bodyImage.imageData;\n        delete bodyImage.fromWhere;\n        delete bodyImage.isActive;\n        const condition = { _id: req.authData._id };\n        Users.findOneAndUpdate(condition, { $push: { Images: bodyImage } }, { new: true })\n          .then((result) => {\n            const userResult = result;\n            userResult.Password = null;\n            userResult._id = null;\n            userResult.IsActive = null;\n            return res.send({ status: true, msg: 'Image Updated Successfully', data: userResult });\n          }).catch((err) => {\n            console.log(err);\n            return res.send({ status: false, msg: 'Image not Updated Successfully' });\n          });\n      }\n      return true;\n    });\n}\n\nexport function setData(req, res) {\n  // res.status(200).json(req.body);\n  const bodyImage = req.body;\n  let newPath;\n\n  const matches = bodyImage.imageData;\n  const index = matches.indexOf('base64');\n  const s1 = matches.substring(0, index + 6);\n  const i = s1.indexOf(':');\n  let type = s1.substring(i + 1, index - 1);\n  const base64Data = matches.substring(index + 7);\n  type = type.split('/');\n  //  console.log('base64Data', base64Data);\n  console.log('type', type);\n  if (bodyImage.fromWhere === 'user') {\n    newPath = `chat${Date.now()}_${Math.ceil(Math.random(100000) * 1000000)}.${type[1]}`;\n  }\n  const fileStream = Buffer.from(base64Data, 'base64');\n\n  return minioClient.bucketExists(process.env.MINIO_BUCKET_NAME, (err2, exists) => {\n    if (err2) {\n      console.log({ status: 500, msg: 'Bucket is not exists', err2 });\n      // resolve(err2);\n      return res.json(err2);\n    }\n    console.log('exists --- ', exists);\n    if (exists) {\n      return putObject(newPath, fileStream, res, bodyImage, req);\n    }\n    return minioClient.makeBucket(process.env.MINIO_BUCKET_NAME, 'us-east-1', (err1) => {\n      if (err1) {\n        console.log(err1);\n        return res.json({ status: 500, msg: 'Image Bucket is not created' });\n      }\n      return putObject(newPath, fileStream, res, bodyImage, req);\n    });\n  });\n}\nfunction getUrlNew(fileName) {\n  return new Promise((resolve, reject) => {\n    minioClient.presignedUrl('GET', process.env.MINIO_BUCKET_NAME, fileName).then((url) => {\n      if (url) { resolve(url); }\n      return resolve(null);\n    }).catch((err) => {\n      console.log(err);\n      reject(null);\n    });\n  });\n}\nexport async function getUrl(fileName) {\n  const url = await getUrlNew(fileName);\n  return url;\n}\n\n"]}